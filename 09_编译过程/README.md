# 第九节：编译过程

接下来几节，我会讲一些编译期相关的优化选项及预编译期相关的优化选项。
至于汇编期和链接期……我就完全不懂了

我不懂汇编语言。
链接期也涉及了很多我完全不懂的问题。

那么，编译期是什么意思？
预编译期又是什么意思？

这个涉及到编译的整个过程。
我记得前面某节好像提到过这个话题，这里详细的讲一下。

## 从源代码（xxx.cpp）生成可执行文件（a.out）一共分为四个阶段：

### 1. 预编译阶段

此时编译器会处理源代码中所有的预编译指令。
预编译指定非常有特点，全部以“#”开头

想想，以“#”开头的命令有哪些

不同的命令有不同的处理方法，#include命令的处理方法就是赤裸裸的复制粘贴。
将#include后面的文件的内容赤裸裸地复制粘贴到#include命令所在的位置。

\#define命令分为带参宏和不带参宏。
\#define命令的处理方法，学名叫宏展开。
其实不带参宏的处理方法就是赤裸裸的字符串替换。

此阶段完成后，会产生一篇完全不包含预编译指令的代码。

使用gcc的-E选项可以查看预编译结果：

    g++ -E xxx.cpp

但是这个命令不会把处理结果保存在文件中，而是放在标准输出中。

例子：见本文最后例一。

### 2. 汇编阶段

此时编译器会将预处理过的代码进行汇编。

使用gcc的-S选项可以查看汇编结果：

    g++ -S xxx.cpp

之后会在当前目录下产生一个xxx.s的文件，里面保存的是汇编代码。

汇编我懂的不多，就不帖了。

### 3. 编译阶段

此时编译器会将汇编代码编译成目标文件。

使用gcc的-c选项可以生成目标文件：

    g++ -c xxx.s

也可以从源代码直接生成目标文件：

    g++ -c xxx.cpp

gcc会通过扩展名自动判断处理的是汇编代码还是C++代码。

到此，（狭义上的）编译器已经完成它的全部工作。

### 4. 链接阶段

此时已经没有编译器的事情了。链接工作交由链接器来处理。
链接器会将多个目标文件链接成可执行文件。

我们可以通过gcc来进行链接，但是实际上，gcc还是调用ld命令来完成链接工作的。

    g++ xx1.o xx2.o

## 本节完

接下来几节，
计划先讲编译阶段的pipe选项、O选项和W选项。
因为编译阶段事情比较少。

然后讲预编译阶段的I选项和D选项。

## 例子

### 例一

main.cpp

    #include "sum.h"
    #define SUCCESS 0
    int main(){
        int c=sum(1,2);
        return SUCCESS;
    }

sum.h

    #ifndef SUM_H
    #define SUM_H

    int sum(int a,int b);

    #endif // SUM_H

预编译

    g++ -E main.cpp

输出

    # 1 "main.cpp"
    # 1 "<built-in>"
    # 1 "<command-line>"
    # 1 "main.cpp"
    # 1 "sum.h" 1

    int sum(int a,int b);
    # 2 "main.cpp" 2

    int main(){
        int c=sum(1,2);
        return 0;
    }
